<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedidos de Clientes</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh; /* Para que el fondo ocupe toda la altura */
        }

        form, .admin-panel {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px; /* Espacio entre el form y el panel admin/botones */
            width: 100%;
            max-width: 600px; /* Ancho m√°ximo para el formulario */
            box-sizing: border-box;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            overflow-x: auto; /* Para tablas grandes en m√≥vil */
            display: block; /* Permite scroll horizontal */
        }

        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
            white-space: nowrap; /* Evita que el texto se rompa en varias l√≠neas */
        }

        th {
            background-color: #007bff;
            color: white;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 16px;
            margin: 5px; /* Espacio entre botones */
            transition: background-color 0.3s ease;
        }

        button:hover:not(:disabled) {
            background-color: #0056b3;
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .admin-panel {
            display: none;
            margin-top: 20px;
        }

        /* Estilos espec√≠ficos para productos */
        .producto-item {
            display: flex;
            flex-wrap: wrap; /* Permite que los elementos se envuelvan en pantallas peque√±as */
            align-items: flex-end; /* Alinea los elementos en la parte inferior */
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 5px;
            background-color: #fcfcfc;
            box-sizing: border-box;
        }

        .producto-item label {
            display: flex;
            flex-direction: column;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .producto-item select,
        .producto-item input[type="number"],
        .producto-item textarea {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .producto-item select {
            width: 180px; /* Ancho fijo para el select de producto */
        }

        .producto-item input[type="number"] {
            width: 70px; /* Ancho fijo para la cantidad */
            text-align: center;
        }

        .producto-item textarea {
            flex-grow: 1; /* Permite que la observaci√≥n ocupe el espacio restante */
            min-width: 150px; /* Ancho m√≠nimo para la observaci√≥n */
            max-width: 100%;
            min-height: 40px;
            resize: vertical;
        }

        .producto-item .eliminar-producto {
            background-color: #dc3545;
            padding: 8px 12px;
            font-size: 14px;
            margin-left: auto; /* Empuja el bot√≥n "X" a la derecha */
        }

        .producto-item .eliminar-producto:hover {
            background-color: #c82333;
        }

        /* Estilos del modal */
        .modal {
            display: none; /* Oculto por defecto */
            position: fixed;
            z-index: 1000; /* Asegura que est√© por encima de todo */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto; /* Habilita scroll si el contenido es muy grande */
            background-color: rgba(0, 0, 0, 0.6); /* Fondo semi-transparente */
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border: 1px solid #888;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            position: relative;
            animation-name: animatetop;
            animation-duration: 0.4s;
            text-align: left; /* Alinea el contenido del modal a la izquierda */
        }

        @keyframes animatetop {
            from {top: -300px; opacity: 0}
            to {top: 0; opacity: 1}
        }

        .modal-content h3 {
            text-align: center;
            color: #0056b3;
            margin-bottom: 20px;
        }

        .modal-content button {
            display: inline-block;
            width: auto;
            margin: 10px 5px;
            font-size: 16px;
        }

        .modal-content #resumenPedido {
            max-height: 300px; /* Altura m√°xima para el resumen de productos */
            overflow-y: auto; /* Habilita scroll si hay muchos productos */
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .modal-content #resumenPedido table {
            width: 100%; /* Asegura que la tabla del resumen ocupe todo el ancho */
            margin-top: 10px;
            margin-bottom: 0;
        }
        .modal-content #resumenPedido th,
        .modal-content #resumenPedido td {
            font-size: 13px;
            padding: 8px;
        }

        /* Mensajes de estado en el modal */
        .modal-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
            display: none; /* Oculto por defecto, se muestra con JS */
        }
        .modal-message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }
        .modal-message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        /* Estilos para el estado de impresi√≥n */
        #estadoImpresion, #estadoImpresionAdmin {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: blue; /* Azul por defecto, verde si hay pendientes */
            margin-bottom: 10px;
            transition: background-color 0.5s ease;
        }
        #nuevoPedido {
            display: none;
            background-color: yellow;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            color: #333;
            margin-left: 10px;
            animation: pulse 1.5s infinite; /* Animaci√≥n para el cartel */
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        /* Contenedor de botones de admin para que est√©n en una l√≠nea */
        .admin-buttons {
            display: flex;
            flex-wrap: wrap; /* Permite que los botones se envuelvan */
            justify-content: center;
            gap: 10px; /* Espacio entre los botones */
            margin-top: 20px;
        }
        .admin-buttons button {
            flex-grow: 1; /* Permite que los botones se expandan */
            max-width: 200px; /* Ancho m√°ximo para cada bot√≥n */
        }
    </style>
</head>
<body>
<div id="estadoImpresion" style="width: 20px; height: 20px; border-radius: 50%; background-color: blue; margin-bottom: 10px;"></div>

<h2>Formulario de Pedido</h2>
<form id="pedidoForm">
    <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 8px;">
        <div>
            <label for="codigoCliente">C√≥digo Cliente:</label><br>
            <input type="text" id="codigoCliente" maxlength="5" minlength="5"
                   oninput="cargarNombreCliente()" autocomplete="off" required pattern=".{5}">
        </div>

        <div>
            <label for="nombre">Nombre:</label><br>
            <input type="text" id="nombre" required readonly>
        </div>
    </div>

    <br>
    <h3>Productos</h3>
    <div id="productosContainer"></div>
    <button type="button" onclick="agregarProducto()">‚ûï Agregar Producto</button><br><br>
    <button type="button" onclick="confirmarPedido()">‚úîÔ∏è Confirmar Pedido</button>
    <button type="button" onclick="anularPedido()">‚ùå Anular Pedido</button>
</form>

<div id="adminPanel" class="admin-panel">
    <h2>Lista de Pedidos</h2>
    <div style="display: flex; align-items: center; margin-bottom: 10px; justify-content: center;">
        <div id="estadoImpresionAdmin" style="width: 20px; height: 20px; border-radius: 50%; background-color: blue; margin-right: 10px;"></div>
        <div id="nuevoPedido" style="display: none; background-color: yellow; padding: 5px 10px; border-radius: 5px; font-weight: bold;">Nuevo Pedido</div>
    </div>
    <table id="tablaPedidos">
        <thead>
            <tr>
                <th>Fecha</th>
                <th>Cliente</th>
                <th>Producto</th>
                <th>Cantidad</th>
                <th>Observaciones</th>
                <th>Impreso</th>
                <th>Eliminar</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <div class="admin-buttons">
        <button onclick="generarPDF()">üìÑ Imprimir Pedidos</button>
        <button onclick="descargarExcel()">üì• Descargar Excel</button>
        <button onclick="eliminarTodosLosPedidos()">üóë Eliminar Todos</button>
        <button onclick="generarPDFCompleto()">Generar PDF Completo</button>
    </div>
</div>
<button onclick="accederAdmin()">üîë Acceder como Administrador</button>
<button type="button" onclick="solicitarClaveParaImpresion()">üñ® Imprimir PDF de Pendientes</button>

<script>
    let clientes = {
        "GEN89": "GENERACI√ìN", "BIT60": "BITFARMS", "ING48": "INGESA", "IPM57": "IPM", "CIS47": "CISAR",
        "VER61": "VERO", "SEN48": "SENASA", "SOL61": "SOLARO", "HYD61": "HYDROBOT", "GOD78": "GODOY CRUZ", "SAL10": "SALTO"
    };

    let productosDisponibles = [
        "PRINCIPAL", "OPCIONAL", "ENSALADA 1", "ENSALADA 2", "ENSALADA 3", "ENSALADA 4",
        "ENSALADA 5", "ENSALADA 6", "ENSALADA 7", "ENSALADA 8", "ENSALADA 9", "ENSALADA 10",
        "ENSALADA 11", "ENSALADA 12", "ENSALADA 13", "ENSALADA 14", "ENSALADA 15", "ENSALADA 19",
        "ENSALADA 20", "ENSALADA 21", "ENSALADA COMUN", "BIFE DE TERNERA", "BIFE DE POLLO",
        "PATA MUSLO AL HORNO", "LOMO DE ATUN", "MILANESA DE POLLO", "MILANESA DE TERNERA",
        "TARTA DE JyQ", "TARTA DE ATUN", "TARTA DE POLLO", "OMELETTE", "PURE", "PURE MIXTO", "PAPA FRITA",
        "ARROZ", "VERDURA AL HORNO", "REFRIGERIO", "OTROS", "GASESOSA"
    ];

    // Se agrega esta l√≠nea para obtener una referencia global al bot√≥n del modal.
    // Es importante que est√© definida antes de que se use en la funci√≥n enviarPedido().
    let btnEnviarPedidoModal;

    document.addEventListener('DOMContentLoaded', (event) => {
        // Aseg√∫rate de que el DOM est√© cargado antes de intentar obtener el elemento
        btnEnviarPedidoModal = document.getElementById('btnEnviarPedidoModal');
        // Tambi√©n inicializa el estado del modal (si no se hace por CSS)
        document.getElementById("modalConfirmacion").style.display = "none";
        actualizarEstado(); // Llama esto al cargar la p√°gina para inicializar los c√≠rculos de estado
    });


    function cargarNombreCliente() {
        let codigo = document.getElementById("codigoCliente").value.toUpperCase();
        document.getElementById("codigoCliente").value = codigo;
        document.getElementById("nombre").value = clientes[codigo] || "";
    }

    function agregarProducto() {
        let container = document.getElementById("productosContainer");
        let div = document.createElement("div");
        div.className = "producto-item";

        let opcionesProductos = productosDisponibles.map(p => `<option value="${p}">${p}</option>`).join("");

        div.innerHTML = `
            <label>Producto:
                <select class="producto">${opcionesProductos}</select>
            </label>
            <label>Cantidad:
                <input type="number" class="cantidad" min="1" required style="width: 60px;" value="1">
            </label>
            <label>Observaci√≥n:
                <textarea class="observacion" rows="4" style="width: 300px; height: 40px;" placeholder="Escribe aqu√≠..."></textarea>
            </label>
            <button type="button" class="eliminar-producto" onclick="this.parentNode.remove()">‚ùå</button>
            <br>
        `;

        container.appendChild(div);
    }

    function confirmarPedido() {
        let nombre = document.getElementById("nombre").value;
        let productos = document.querySelectorAll(".producto");
        let cantidades = document.querySelectorAll(".cantidad"); // Aseg√∫rate de obtener todas las cantidades
        let observaciones = document.querySelectorAll(".observacion"); // Aseg√∫rate de obtener todas las observaciones

        // Validar que al menos el nombre y un producto est√©n presentes
        if (!nombre || productos.length === 0 || !productos[0].value) { // Verifica tambi√©n que el primer producto tenga un valor
            alert("Debes ingresar un c√≥digo de cliente v√°lido (con nombre) y al menos un producto seleccionado.");
            return;
        }

        // Validar que todos los productos agregados tengan un valor de producto y cantidad
        let isValid = true;
        productos.forEach((producto, index) => {
            if (!producto.value || !cantidades[index].value || parseInt(cantidades[index].value) <= 0) {
                isValid = false;
            }
        });

        if (!isValid) {
            alert("Por favor, aseg√∫rate de que todos los productos agregados tengan un producto seleccionado y una cantidad v√°lida (mayor que 0).");
            return;
        }


        let resumen = `<p><strong>Cliente:</strong> ${nombre}</p>`;
        resumen += `<table border="1" style="width: 100%; text-align: center;">
                            <tr>
                                <th>Producto</th>
                                <th>Cantidad</th>
                                <th>Observaciones</th>
                            </tr>`;

        productos.forEach((producto, index) => {
            resumen += `<tr>
                                <td>${producto.value}</td>
                                <td>${cantidades[index].value}</td>
                                <td>${observaciones[index].value || "Sin observaciones"}</td>
                            </tr>`;
        });

        resumen += `</table>`;

        document.getElementById("resumenPedido").innerHTML = resumen;
        document.getElementById("modalConfirmacion").style.display = "flex"; // Muestra el modal
        // Aseg√∫rate de resetear el estado del bot√≥n y mensaje del modal al abrirlo
        if (btnEnviarPedidoModal) {
            btnEnviarPedidoModal.disabled = false;
            btnEnviarPedidoModal.textContent = 'Enviar Pedido';
        }
        const mensajeEstadoModal = document.getElementById('mensajeEstadoModal');
        if (mensajeEstadoModal) {
            mensajeEstadoModal.textContent = '';
            mensajeEstadoModal.className = 'modal-message';
        }
    }

    function obtenerFechaFormateada() {
        const ahora = new Date();
        const dia = String(ahora.getDate()).padStart(2, '0');
        const mes = String(ahora.getMonth() + 1).padStart(2, '0');
        const anio = ahora.getFullYear();
        const horas = String(ahora.getHours()).padStart(2, '0');
        const minutos = String(ahora.getMinutes()).padStart(2, '0');
        return `${dia}/${mes}/${anio} ${horas}:${minutos}`;
    }

    // --- FUNCION CLAVE: enviarPedidoAGoogleSheets con reintentos ---
    async function enviarPedidoAGoogleSheets(fecha, cliente, producto, cantidad, observacion, impreso, retryCount = 0) {
        const MAX_RETRIES = 3; // N√∫mero m√°ximo de reintentos
        const BASE_DELAY_MS = 1000; // Retardo base de 1 segundo

        var pedido = {
            fecha: fecha,
            cliente: cliente,
            producto: producto,
            cantidad: cantidad,
            observacion: observacion,
            impreso: impreso
        };

        try {
            const response = await fetch("https://script.google.com/macros/s/AKfycbzEOzjUzvrKH994MYlF_Rp_uSflvco6wvLDV9IN5hbi8u6ncBjEDv2QDhKU1jyRvNs/exec", {
                method: 'POST',
                mode: 'no-cors', // Importante para Apps Script si no manejas CORS espec√≠ficamente
                body: JSON.stringify(pedido),
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            console.log(`Intento ${retryCount + 1}: Solicitud para "${producto}" enviada a Google Sheets. Respondi√≥:`, response.type);
            // Debido a 'no-cors', no podemos verificar el estado HTTP exacto.
            // Asumimos √©xito si no hay un error de red y la promesa se resuelve.
        } catch (error) {
            console.error(`Intento ${retryCount + 1}: Error al guardar pedido "${producto}" en Google Sheets:`, error);

            if (retryCount < MAX_RETRIES) {
                const delay = BASE_DELAY_MS * Math.pow(2, retryCount) + Math.floor(Math.random() * 500); // Retardo exponencial con jitter
                console.log(`Reintentando env√≠o para "${producto}" en ${delay / 1000} segundos... (Intento ${retryCount + 1} de ${MAX_RETRIES})`);
                await new Promise(resolve => setTimeout(resolve, delay));
                return enviarPedidoAGoogleSheets(fecha, cliente, producto, cantidad, observacion, impreso, retryCount + 1);
            } else {
                console.error(`ERROR FINAL: Fallo el env√≠o de "${producto}" a Google Sheets despu√©s de ${MAX_RETRIES} reintentos.`);
                throw error; // Propagar el error si todos los reintentos fallan
            }
        }
    }

    // --- FUNCION PRINCIPAL DE ENVIO DE PEDIDOS ---
    async function enviarPedido() {
        // Obtener referencia al bot√≥n y al div de mensaje dentro del modal
        const btnEnviarPedidoModal = document.getElementById('btnEnviarPedidoModal');
        const mensajeEstadoModal = document.getElementById('mensajeEstadoModal');

        // 1. Deshabilitar el bot√≥n y mostrar un mensaje de carga
        if (btnEnviarPedidoModal) {
            btnEnviarPedidoModal.disabled = true;
            btnEnviarPedidoModal.textContent = 'Enviando...';
        }
        if (mensajeEstadoModal) {
            mensajeEstadoModal.textContent = 'Procesando tu solicitud, por favor espera...';
            mensajeEstadoModal.className = 'modal-message'; // Reinicia las clases de mensaje
        }

        let nombre = document.getElementById("nombre").value;
        let productos = document.querySelectorAll(".producto");
        let cantidades = document.querySelectorAll(".cantidad");
        let observaciones = document.querySelectorAll(".observacion");

        // Esta validaci√≥n se hizo en confirmarPedido(), pero es buena pr√°ctica mantenerla aqu√≠ tambi√©n
        // para asegurar que no se env√≠e con datos vac√≠os si el modal se abre de otra forma.
        if (!nombre || productos.length === 0 || !productos[0].value) {
            alert("Debes ingresar un nombre y al menos un producto.");
            if (btnEnviarPedidoModal) {
                btnEnviarPedidoModal.disabled = false;
                btnEnviarPedidoModal.textContent = 'Enviar Pedido';
            }
            if (mensajeEstadoModal) {
                mensajeEstadoModal.textContent = '';
                mensajeEstadoModal.className = 'modal-message';
            }
            return;
        }

        let pedidosEnLocalStorage = JSON.parse(localStorage.getItem("pedidos")) || [];
        let fecha = obtenerFechaFormateada();

        let rowsParaPdf = [];
        let hayErroresDeEnvio = false; // Bandera para saber si hubo alg√∫n fallo

        // Recorremos los productos usando un bucle for...of para poder usar await
        for (let i = 0; i < productos.length; i++) {
            let productoVal = products[i].value; // Cambi√© 'products' a 'productos'
            let cantidadVal = parseInt(cantidades[i].value);
            let observacionVal = observaciones[i].value;

            const pedidoData = {
                fecha,
                nombre,
                producto: productoVal,
                cantidad: cantidadVal,
                observacion: observacionVal,
                impreso: "No"
            };

            // Guarda en localStorage *inmediatamente* (es local y r√°pido)
            pedidosEnLocalStorage.push(pedidoData);

            try {
                // Esperamos que cada env√≠o a Google Sheets se complete antes de continuar
                // La funci√≥n de env√≠o ahora maneja sus propios reintentos.
                await enviarPedidoAGoogleSheets(
                    pedidoData.fecha,
                    pedidoData.nombre,
                    pedidoData.producto,
                    pedidoData.cantidad,
                    pedidoData.observacion,
                    pedidoData.impreso
                );
            } catch (error) {
                // Este catch solo se activar√° si todos los reintentos dentro
                // de enviarPedidoAGoogleSheets fallan.
                console.error(`ERROR FATAL: El pedido para "${pedidoData.producto}" no pudo ser enviado despu√©s de m√∫ltiples reintentos.`);
                hayErroresDeEnvio = true;
            }

            rowsParaPdf.push([
                productoVal,
                cantidadVal,
                observacionVal || "Sin observaciones"
            ]);
        }

        localStorage.setItem("pedidos", JSON.stringify(pedidosEnLocalStorage));

        // Generar PDF autom√°ticamente
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(14);
        doc.text(`Pedido de: ${nombre}`, 10, 10);
        doc.text(`Fecha: ${fecha}`, 10, 20);

        doc.autoTable({
            startY: 30,
            head: [['Producto', 'Cantidad', 'Observaciones']],
            body: rowsParaPdf,
        });

        doc.save(`Pedido_${nombre}_${fecha.replace(/[/: ]/g, '_')}.pdf`);

        // Mensaje final al usuario
        if (hayErroresDeEnvio) {
            alert("¬°Proceso de env√≠o completado con ALGUNOS ERRORES! No todos los pedidos pudieron ser registrados en Google Sheets despu√©s de varios reintentos. Por favor, revisa la consola del navegador y los logs de Google Apps Script.");
            if (mensajeEstadoModal) {
                mensajeEstadoModal.textContent = 'Hubo errores al enviar algunos pedidos. Revisa la consola.';
                mensajeEstadoModal.classList.add('error');
            }
            // Si hubo errores, re-habilitamos el bot√≥n para que el usuario pueda intentar de nuevo
            if (btnEnviarPedidoModal) {
                btnEnviarPedidoModal.disabled = false;
                btnEnviarPedidoModal.textContent = 'Enviar Pedido';
            }
        } else {
            alert("¬°Proceso de env√≠o de pedidos completado exitosamente! Todos los pedidos fueron registrados en Google Sheets.");
            if (mensajeEstadoModal) {
                mensajeEstadoModal.textContent = '¬°Pedido enviado con √©xito!';
                mensajeEstadoModal.classList.add('success');
            }
            // Si todo fue exitoso, el bot√≥n puede permanecer deshabilitado o cerrarse el modal.
            // Aqu√≠ elegimos cerrar el modal.
        }

        // Limpieza visual
        document.getElementById("pedidoForm").reset();
        document.getElementById("productosContainer").innerHTML = "";
        actualizarEstado();

        // Cierra el modal despu√©s de que el proceso termina y se muestra el mensaje final.
        // Si hay un mensaje de error, es posible que quieras dejar el modal abierto por un tiempo
        // para que el usuario vea el error, o solo cerrarlo si fue exitoso.
        // Para este ejemplo, lo cerraremos de todas formas despu√©s del alert.
        cerrarModal();
    }

    function cerrarModal() {
        document.getElementById("modalConfirmacion").style.display = "none";
        // Restablece el estado inicial del bot√≥n del modal al cerrar
        if (btnEnviarPedidoModal) {
            btnEnviarPedidoModal.disabled = false;
            btnEnviarPedidoModal.textContent = 'Enviar Pedido';
        }
        const mensajeEstadoModal = document.getElementById('mensajeEstadoModal');
        if (mensajeEstadoModal) {
            mensajeEstadoModal.textContent = '';
            mensajeEstadoModal.className = 'modal-message';
        }
    }

    // --- FUNCION ANULAR PEDIDO con reintentos ---
    async function anularPedido() {
        let nombre = document.getElementById("nombre").value;
        let productos = document.querySelectorAll(".producto");
        let cantidades = document.querySelectorAll(".cantidad");
        let observaciones = document.querySelectorAll(".observacion");

        if (!nombre || productos.length === 0) {
            alert("Debes ingresar un nombre y al menos un producto para anular.");
            return;
        }

        let fecha = obtenerFechaFormateada();
        let pedidosEnLocalStorage = JSON.parse(localStorage.getItem("pedidos")) || [];
        let hayErroresDeAnulacion = false;

        // Deshabilitar botones de anular y confirmar durante el proceso
        document.querySelector('button[onclick="confirmarPedido()"]').disabled = true;
        document.querySelector('button[onclick="anularPedido()"]').disabled = true;
        document.querySelector('button[onclick="confirmarPedido()"]').textContent = 'Procesando...';
        document.querySelector('button[onclick="anularPedido()"]').textContent = 'Procesando...';


        for (let i = 0; i < productos.length; i++) {
            let cantidadNegativa = -parseInt(cantidades[i].value);
            const pedidoAnuladoData = {
                fecha,
                nombre,
                producto: productos[i].value,
                cantidad: cantidadNegativa,
                observacion: observaciones[i].value,
                impreso: "No"
            };

            pedidosEnLocalStorage.push(pedidoAnuladoData);

            try {
                await enviarPedidoAGoogleSheets(
                    pedidoAnuladoData.fecha,
                    pedidoAnuladoData.nombre,
                    pedidoAnuladoData.producto,
                    pedidoAnuladoData.cantidad,
                    pedidoAnuladoData.observacion,
                    pedidoAnuladoData.impreso
                );
            } catch (error) {
                console.error(`ERROR FATAL: La anulaci√≥n para "${pedidoAnuladoData.producto}" no pudo ser enviada despu√©s de m√∫ltiples reintentos.`);
                hayErroresDeAnulacion = true;
            }
        }

        localStorage.setItem("pedidos", JSON.stringify(pedidosEnLocalStorage));

        if (hayErroresDeAnulacion) {
            alert("¬°Proceso de anulaci√≥n completado con ALGUNOS ERRORES! No todas las anulaciones pudieron ser registradas en Google Sheets. Revisa la consola.");
        } else {
            alert("¬°Pedido anulado correctamente! Todas las anulaciones fueron registradas en Google Sheets.");
        }

        document.getElementById("pedidoForm").reset();
        document.getElementById("productosContainer").innerHTML = "";
        actualizarEstado();
        cerrarModal(); // Aseg√∫rate de cerrar el modal si est√° abierto

        // Re-habilitar botones
        document.querySelector('button[onclick="confirmarPedido()"]').disabled = false;
        document.querySelector('button[onclick="anularPedido()"]').disabled = false;
        document.querySelector('button[onclick="confirmarPedido()"]').textContent = '‚úîÔ∏è Confirmar Pedido';
        document.querySelector('button[onclick="anularPedido()"]').textContent = '‚ùå Anular Pedido';
    }


    function descargarPDFPedido() {
        let nombre = document.getElementById("nombre").value;
        let productos = document.querySelectorAll(".producto");
        let cantidades = document.querySelectorAll(".cantidad");
        let observaciones = document.querySelectorAll(".observacion");

        if (!nombre || products.length === 0) {
            alert("Debes completar un pedido antes de generar el PDF.");
            return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        let fecha = obtenerFechaFormateada();

        doc.setFontSize(14);
        doc.text(`Pedido de: ${nombre}`, 10, 10);
        doc.text(`Fecha: ${fecha}`, 10, 20);

        let rows = [];

        productos.forEach((producto, index) => {
            rows.push([
                producto.value,
                cantidades[index].value,
                observaciones[index].value || "Sin observaciones"
            ]);
        });

        doc.autoTable({
            startY: 30,
            head: [['Producto', 'Cantidad', 'Observaciones']],
            body: rows,
        });

        doc.save(`Pedido_${nombre}_${fecha.replace(/[/: ]/g, '_')}.pdf`);
    }

    function accederAdmin() {
        let clave = prompt("Ingrese la clave de administrador:");
        if (clave === "admin123") {
            document.getElementById("adminPanel").style.display = "block";
            mostrarPedidos();
            actualizarEstado();
        } else {
            alert("Clave incorrecta.");
        }
    }

    function solicitarClaveParaImpresion() {
        const claveCorrecta = "admin123";
        const claveIngresada = prompt("Ingrese la clave para imprimir:");

        if (claveIngresada === claveCorrecta) {
            generarPDF();
        } else {
            alert("Clave incorrecta. No se puede imprimir.");
        }
    }

    function eliminarTodosLosPedidos() {
        if (confirm("¬øEst√°s seguro de que quieres eliminar todos los pedidos? Esta acci√≥n no se puede deshacer.")) {
            localStorage.removeItem("pedidos");
            mostrarPedidos();
            actualizarEstado();
            alert("Todos los pedidos han sido eliminados.");
        }
    }

    function mostrarPedidos() {
        let pedidos = JSON.parse(localStorage.getItem("pedidos")) || [];

        // Limita a los √∫ltimos 200 pedidos para evitar problemas de rendimiento
        if (pedidos.length > 200) {
            pedidos = pedidos.slice(-200);
            localStorage.setItem("pedidos", JSON.stringify(pedidos));
        }

        let tbody = document.querySelector("#tablaPedidos tbody");
        tbody.innerHTML = "";
        pedidos.forEach((p, index) => {
            let fila = `<tr>
                <td>${p.fecha}</td>
                <td>${p.nombre}</td>
                <td>${p.producto}</td>
                <td>${p.cantidad}</td>
                <td>${p.observacion || "N/A"}</td>
                <td>${p.impreso}</td>
                <td><button onclick="eliminarPedido(${index})">‚ùå</button></td>
            </tr>`;
            tbody.innerHTML += fila;
        });
    }

    // Se cambi√≥ a DOMContentLoaded para asegurar que el DOM est√© completamente cargado
    // antes de intentar obtener elementos o manipularlos.
    // Esto es m√°s robusto que window.onload para scripts que pueden ejecutarse antes.
    // document.addEventListener('DOMContentLoaded', (event) => {
    //     actualizarEstado();
    // });


    function eliminarPedido(index) {
        let pedidos = JSON.parse(localStorage.getItem("pedidos")) || [];
        pedidos.splice(index, 1);
        localStorage.setItem("pedidos", JSON.stringify(pedidos));
        mostrarPedidos();
        actualizarEstado();
    }


    function generarPDF() {
        const { jsPDF } = window.jspdf;
        let doc = new jsPDF({ orientation: "landscape" });
        let pedidos = JSON.parse(localStorage.getItem("pedidos")) || [];

        let pedidosNoImpresos = pedidos.filter(p => p.impreso === "No");

        if (pedidosNoImpresos.length === 0) {
            alert("No hay pedidos nuevos para imprimir.");
            return;
        }

        let fechaActual = new Date().toLocaleDateString();

        doc.setFontSize(14);
        doc.text(`Pedidos - Cuadro de Doble Entrada`, 14, 15);
        doc.text(`Fecha: ${fechaActual}`, 240, 15);

        let clientesUnicos = [...new Set(pedidosNoImpresos.map(p => p.nombre))];
        let productosUnicos = [...new Set(pedidosNoImpresos.map(p => p.producto))];

        let tableHead = [["Producto", ...clientesUnicos]];
        let tableBody = productosUnicos.map(prod => {
            let row = [prod];
            clientesUnicos.forEach(cliente => {
                let total = pedidosNoImpresos
                    .filter(p => p.nombre === cliente && p.producto === prod)
                    .reduce((sum, p) => sum + p.cantidad, 0);
                row.push(total > 0 ? total : "");
            });
            return row;
        });

        doc.autoTable({ head: tableHead, body: tableBody, startY: 25 });

        let startY = doc.autoTable.previous.finalY + 10;
        doc.text("Observaciones por Cliente y Producto", 14, startY);
        startY += 6;

        let observacionesAgrupadas = {};
        pedidosNoImpresos.forEach(p => {
            if (p.observacion && p.observacion.trim()) { // Asegura que la observaci√≥n no est√© vac√≠a
                if (!observacionesAgrupadas[p.nombre]) {
                    observacionesAgrupadas[p.nombre] = [];
                }
                observacionesAgrupadas[p.nombre].push(`${p.producto}: ${p.observacion}`);
            }
        });

        if (Object.keys(observacionesAgrupadas).length > 0) {
            Object.entries(observacionesAgrupadas).forEach(([cliente, observaciones]) => {
                doc.setFontSize(12);
                doc.text(`${cliente}: ${observaciones.join("; ")}`, 14, startY);
                startY += 6;
            });
        } else {
            doc.setFontSize(12);
            doc.text("No hay observaciones.", 14, startY);
            startY += 6;
        }


        pedidos.forEach(p => {
            // Marcar como impreso solo si el pedido completo coincide con uno de los no impresos que se incluyeron en este PDF
            // Esto es crucial para evitar marcar pedidos que no se incluyeron en la impresi√≥n actual.
            const isIncludedAndNotYetPrinted = pedidosNoImpresos.some(noImp =>
                noImp.fecha === p.fecha &&
                noImp.nombre === p.nombre &&
                noImp.producto === p.producto &&
                noImp.cantidad === p.cantidad &&
                noImp.observacion === p.observacion &&
                p.impreso === "No" // Solo marca si a√∫n no est√° impreso
            );
            if (isIncludedAndNotYetPrinted) {
                p.impreso = "S√≠";
            }
        });


        localStorage.setItem("pedidos", JSON.stringify(pedidos));

        actualizarEstado();

        doc.save(`Pedidos_No_Impresos_${fechaActual}.pdf`);
    }

    function actualizarEstado() {
        const pedidos = JSON.parse(localStorage.getItem("pedidos")) || [];
        const hayPendientes = pedidos.some(p => p.impreso === "No");

        const estadoForm = document.getElementById("estadoImpresion");
        const estadoAdmin = document.getElementById("estadoImpresionAdmin");
        const cartel = document.getElementById("nuevoPedido");

        if (hayPendientes) {
            if (estadoForm) estadoForm.style.backgroundColor = "green";
            if (estadoAdmin) estadoAdmin.style.backgroundColor = "green";
            if (cartel) cartel.style.display = "block";
        } else {
            if (estadoForm) estadoForm.style.backgroundColor = "blue";
            if (estadoAdmin) estadoAdmin.style.backgroundColor = "blue";
            if (cartel) cartel.style.display = "none";
        }
        mostrarPedidos(); // Aseg√∫rate de refrescar la tabla de pedidos
    }

    function generarPDFCompleto() {
        const { jsPDF } = window.jspdf;
        let doc = new jsPDF({ orientation: "landscape" });
        let pedidos = JSON.parse(localStorage.getItem("pedidos")) || [];

        if (pedidos.length === 0) {
            alert("No hay pedidos para imprimir.");
            return;
        }

        let clientesUnicos = [...new Set(pedidos.map(p => p.nombre))];
        let productosUnicos = [...new Set(pedidos.map(p => p.producto))];

        let tableHead = [["Producto", ...clientesUnicos]];
        let tableBody = productosUnicos.map(prod => {
            let row = [prod];
            clientesUnicos.forEach(cliente => {
                let total = pedidos
                    .filter(p => p.nombre === cliente && p.producto === prod)
                    .reduce((sum, p) => sum + p.cantidad, 0);
                row.push(total > 0 ? total : "");
            });
            return row;
        });

        doc.setFontSize(14);
        doc.text("Pedidos - Cuadro de Doble Entrada (Completo)", 14, 15);
        doc.autoTable({ head: tableHead, body: tableBody, startY: 20 });

        let startY = doc.autoTable.previous.finalY + 10;
        doc.setFontSize(14);
        doc.text("Observaciones por Cliente y Producto", 14, startY);
        startY += 6;

        let observacionesAgrupadas = {};
        pedidos.forEach(p => {
            if (p.observacion && p.observacion.trim()) {
                if (!observacionesAgrupadas[p.nombre]) {
                    observacionesAgrupadas[p.nombre] = [];
                }
                observacionesAgrupadas[p.nombre].push(`${p.producto}: ${p.observacion}`);
            }
        });

        if (Object.keys(observacionesAgrupadas).length > 0) {
            Object.entries(observacionesAgrupadas).forEach(([cliente, observaciones]) => {
                doc.setFontSize(12);
                doc.text(`${cliente}: ${observaciones.join("; ")}`, 14, startY);
                startY += 6;
            });
        } else {
            doc.setFontSize(12);
            doc.text("No hay observaciones.", 14, startY);
            startY += 6;
        }

        doc.save("Pedidos_Completos.pdf");
    }

    function descargarExcel() {
        let pedidos = JSON.parse(localStorage.getItem("pedidos")) || [];
        let ws = XLSX.utils.json_to_sheet(pedidos);
        let wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Pedidos");
        XLSX.writeFile(wb, "Pedidos.xlsx");
    }

</script>
<div id="modalConfirmacion" class="modal">
    <div class="modal-content">
        <h3>Resumen del Pedido</h3>
        <div id="resumenPedido"></div>
        <div id="mensajeEstadoModal" class="modal-message"></div> <button id="btnEnviarPedidoModal" onclick="enviarPedido()">Enviar Pedido</button>
        <button onclick="cerrarModal()">Cancelar</button>
    </div>
</div>

</body>
</html>
