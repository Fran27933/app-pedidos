<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedidos de Clientes</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        .producto-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }

        .producto-item label {
            display: flex;
            flex-direction: column;
            font-weight: bold;
        }

        .producto-item textarea {
            width: 150px;
            min-height: 30px;
            resize: vertical;
            padding: 5px;
            font-size: 14px;
        }
        
        .modal { 
            display: none; 
            position: fixed; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0, 0, 0, 0.5); 
            justify-content: center; 
            align-items: center; 
            z-index: 1000; /* Asegurarse de que est√© por encima de todo */
        }
        .modal-content { 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            text-align: center; 
            max-width: 500px;
            width: 90%;
            box-shadow: 0px 0px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        .modal-content button {
            margin: 5px;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
        }
        .modal-content button:hover:not(:disabled) {
            background-color: #0056b3;
        }
        .modal-content button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .modal-content .close-button {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #aaa;
        }
        .modal-content .close-button:hover {
            color: #000;
        }


        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* usa center si quieres que todo quede verticalmente al medio */
            background-color: #f4f4f4;
            padding: 20px;
        }

        form {
            width: 100%;
            max-width: 600px; /* Ajusta seg√∫n tu dise√±o */
            background: white; /* A√±adido para que el formulario tenga fondo */
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 0px 10px #aaa;
            margin-bottom: 20px; /* Espacio debajo del formulario */
        }

        #productosContainer {
            width: 100%;
        }     
        
        /* Estilos generales para botones y tablas */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid black; padding: 10px; text-align: center; }
        th { background-color: #007bff; color: white; }
        button { background-color: #007bff; color: white; border: none; padding: 10px; cursor: pointer; border-radius: 5px; }
        button:hover { background-color: #0056b3; }
        .admin-panel { display: none; margin-top: 20px; background: white; padding: 20px; border-radius: 10px; box-shadow: 0px 0px 10px #aaa; width: 100%; max-width: 800px; } /* Ajustado el ancho */
    </style>
</head>
<body>
<div id="estadoImpresion" style="width: 16px; height: 16px; border-radius: 50%; background-color: blue; margin-bottom: 10px;"></div>

<h2>Formulario de Pedido</h2>
<form id="pedidoForm">
    <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 8px;">
        <div>
            <label for="codigoCliente">C√≥digo Cliente:</label><br>
            <input type="text" id="codigoCliente" maxlength="5" minlength="5"
                   oninput="cargarNombreCliente()" autocomplete="off" required pattern=".{5}">
        </div>

        <div>
            <label for="nombre">Nombre:</label><br>
            <input type="text" id="nombre" required readonly>
        </div>
    </div>

    <br>
    <h3>Productos</h3>
    <div id="productosContainer"></div>
    <button type="button" onclick="agregarProducto()">‚ûï Agregar Producto</button><br><br>
    <button type="button" onclick="abrirModalConfirmacion()">‚úîÔ∏èConfirmar Pedido</button>
    <button type="button" onclick="anularPedido()">‚ùåAnular Pedido</button>   
</form>

<div id="adminPanel" class="admin-panel">
    <h2>Lista de Pedidos</h2>
    <div style="display: flex; align-items: center; margin-bottom: 10px;">
        <div id="estadoImpresionAdmin" style="width: 20px; height: 20px; border-radius: 50%; background-color: blue; margin-right: 10px;"></div>
        <div id="nuevoPedido" style="display: none; background-color: yellow; padding: 5px 10px; border-radius: 5px; font-weight: bold;">Nuevo Pedido</div>
    </div>
    <table id="tablaPedidos">
        <thead>
            <tr>
                <th>Fecha</th>
                <th>Cliente</th>
                <th>Producto</th>
                <th>Cantidad</th>
                <th>Observaciones</th>
                <th>Impreso</th>
                <th>Eliminar</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <button onclick="generarPDF()">üìÑ Imprimir Pedidos</button>
    <button onclick="descargarExcel()">üì• Descargar Excel</button>
    <button onclick="eliminarTodosLosPedidos()">üóë Eliminar Todos</button>
    <button onclick="generarPDFCompleto()">Generar PDF Completo</button>
</div>
<button onclick="accederAdmin()">üîë Acceder como Administrador</button>
<button type="button" onclick="solicitarClaveParaImpresion()">üñ® Imprimir PDF</button>

<script>
    let clientes = {
        "GEN89": "GENERACI√ìN", "BIT60": "BITFARMS", "ING48": "INGESA", "IPM57": "IPM", "CIS47": "CISAR",
        "VER61": "VERO", "SEN48": "SENASA", "SOL61": "SOLARO", "HYD61": "HYDROBOT", "GOD78": "GODOY CRUZ", "SAL10": "SALTO"
    };
    
    let productosDisponibles = [
        "PRINCIPAL", "OPCIONAL", "ENSALADA 1", "ENSALADA 2", "ENSALADA 3", "ENSALADA 4",
        "ENSALADA 5", "ENSALADA 6", "ENSALADA 7", "ENSALADA 8", "ENSALADA 9", "ENSALADA 10",
        "ENSALADA 11", "ENSALADA 12", "ENSALADA 13", "ENSALADA 14", "ENSALADA 15", "ENSALADA 19", 
        "ENSALADA 20", "ENSALADA 21", "ENSALADA COMUN", "BIFE DE TERNERA", "BIFE DE POLLO", 
        "PATA MUSLO AL HORNO", "LOMO DE ATUN", "MILANESA DE POLLO", "MILANESA DE TERNERA", 
        "TARTA DE JyQ", "TARTA DE ATUN", "TARTA DE POLLO", "OMELETTE", "PURE", "PURE MIXTO", "PAPA FRITA", 
        "ARROZ", "VERDURA AL HORNO", "REFRIGERIO", "OTROS", "GASESOSA"
    ];

    // Referencias a elementos del DOM para evitar buscarlos repetidamente
    const modalConfirmacion = document.getElementById("modalConfirmacion");
    const resumenPedidoDiv = document.getElementById("resumenPedido");
    const btnEnviarModal = document.getElementById("btnEnviarModal"); // Nuevo ID para el bot√≥n de enviar dentro del modal
    const modalStatusMessage = document.getElementById("modalStatusMessage"); // Nuevo elemento para el mensaje de estado en el modal
    const codigoClienteInput = document.getElementById("codigoCliente");
    const nombreClienteInput = document.getElementById("nombre");
    const productosContainer = document.getElementById("productosContainer");
    const pedidoForm = document.getElementById("pedidoForm");


    function cargarNombreCliente() {
        let codigo = codigoClienteInput.value.toUpperCase();
        codigoClienteInput.value = codigo; 
        nombreClienteInput.value = clientes[codigo] || "";
    }

    function agregarProducto() {
        let div = document.createElement("div");
        div.className = "producto-item";

        let opcionesProductos = productosDisponibles.map(p => `<option value="${p}">${p}</option>`).join("");

        div.innerHTML = `
            <label>Producto: 
                <select class="producto">${opcionesProductos}</select>
            </label>
            <label>Cantidad: 
                <input type="number" class="cantidad" min="1" required style="width: 60px;" value="1">
            </label>
            <label>Observaci√≥n: 
                <textarea class="observacion" rows="4" style="width: 300px; height: 40px;" placeholder="Escribe aqu√≠..."></textarea>
            </label>
            <button type="button" class="eliminar-producto" onclick="this.parentNode.remove()">‚ùå</button>
            <br>
        `;

        productosContainer.appendChild(div);
    }

    // --- NUEVA FUNCI√ìN: Abrir Modal de Confirmaci√≥n ---
    function abrirModalConfirmacion() {
        let nombre = nombreClienteInput.value;
        let productos = document.querySelectorAll(".producto");

        if (!nombre || productos.length === 0) {
            alert("Debes ingresar un nombre y al menos un producto.");
            return;
        }

        // Limpiar cualquier mensaje de estado previo en el modal
        modalStatusMessage.textContent = '';
        modalStatusMessage.className = ''; // Limpiar clases de estado
        btnEnviarModal.disabled = false; // Asegurarse de que el bot√≥n est√© habilitado al abrir el modal
        btnEnviarModal.textContent = 'Enviar Pedido'; // Restaurar texto del bot√≥n

        let resumen = `<p><strong>Cliente:</strong> ${nombre}</p>`;
        resumen += `<table border="1" style="width: 100%; text-align: center;">
                            <tr>
                                <th>Producto</th>
                                <th>Cantidad</th>
                                <th>Observaciones</th>
                            </tr>`;

        productos.forEach((producto, index) => {
            let cantidades = document.querySelectorAll(".cantidad");
            let observaciones = document.querySelectorAll(".observacion");
            resumen += `<tr>
                                <td>${producto.value}</td>
                                <td>${cantidades[index].value}</td>
                                <td>${observaciones[index].value || "Sin observaciones"}</td>
                            </tr>`;
        });

        resumen += `</table>`;

        resumenPedidoDiv.innerHTML = resumen;
        modalConfirmacion.style.display = "flex"; // Mostrar el modal
    }

    function obtenerFechaFormateada() {
        const ahora = new Date();
        const dia = String(ahora.getDate()).padStart(2, '0');
        const mes = String(ahora.getMonth() + 1).padStart(2, '0');
        const anio = ahora.getFullYear();
        const horas = String(ahora.getHours()).padStart(2, '0');
        const minutos = String(ahora.getMinutes()).padStart(2, '0');
        return `${dia}/${mes}/${anio} ${horas}:${minutos}`;
    }

    // --- FUNCION CLAVE: enviarPedidoAGoogleSheets con reintentos ---
    async function enviarPedidoAGoogleSheets(fecha, cliente, producto, cantidad, observacion, impreso, retryCount = 0) {
        const MAX_RETRIES = 3; // N√∫mero m√°ximo de reintentos
        const BASE_DELAY_MS = 1000; // Retardo base de 1 segundo

        var pedido = {
            fecha: fecha,
            cliente: cliente,
            producto: producto,
            cantidad: cantidad,
            observacion: observacion,
            impreso: impreso
        };

        try {
            const response = await fetch("https://script.google.com/macros/s/AKfycbzEOzjUzvrKH994MYlF_Rp_uSflvco6wvLDV9IN5hbi8u6ncBjEDv2QDhKU1jyRvNs/exec", {
                method: 'POST',
                mode: 'no-cors', // Importante para Apps Script
                body: JSON.stringify(pedido),
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            console.log(`Intento ${retryCount + 1}: Solicitud para "${producto}" enviada a Google Sheets. Respondi√≥:`, response.type);
            // Debido a 'no-cors', no podemos verificar el estado HTTP exacto.
            // Asumimos √©xito si no hay un error de red y la promesa se resuelve.
            return true; // Indica √©xito
        } catch (error) {
            console.error(`Intento ${retryCount + 1}: Error al guardar pedido "${producto}" en Google Sheets:`, error);
            
            if (retryCount < MAX_RETRIES) {
                const delay = BASE_DELAY_MS * Math.pow(2, retryCount) + Math.floor(Math.random() * 500); // Retardo exponencial con jitter
                console.log(`Reintentando env√≠o para "${producto}" en ${delay / 1000} segundos... (Intento ${retryCount + 1} de ${MAX_RETRIES})`);
                await new Promise(resolve => setTimeout(resolve, delay));
                return enviarPedidoAGoogleSheets(fecha, cliente, producto, cantidad, observacion, impreso, retryCount + 1);
            } else {
                console.error(`ERROR FINAL: Fallo el env√≠o de "${producto}" a Google Sheets despu√©s de ${MAX_RETRIES} reintentos.`);
                throw error; // Propagar el error si todos los reintentos fallan
            }
        }
    }

    // --- FUNCION PRINCIPAL DE ENVIO DE PEDIDOS (llamada desde el modal) ---
    async function enviarPedido() {
        // Deshabilitar el bot√≥n de env√≠o en el modal y cambiar su texto
        btnEnviarModal.disabled = true;
        btnEnviarModal.textContent = 'Enviando...';
        modalStatusMessage.textContent = 'Enviando pedido, por favor espere...';
        modalStatusMessage.className = 'message-container'; // Solo para asegurar que se muestre

        let nombre = nombreClienteInput.value;
        let productos = document.querySelectorAll(".producto");
        let cantidades = document.querySelectorAll(".cantidad");
        let observaciones = document.querySelectorAll(".observacion");

        // Esta validaci√≥n ya se hace al abrir el modal, pero la mantenemos por seguridad.
        if (!nombre || productos.length === 0) {
            modalStatusMessage.textContent = "Error: Faltan datos del pedido. Por favor, reabr√≠ el formulario.";
            modalStatusMessage.className = 'message-container error-message';
            btnEnviarModal.disabled = false; // Re-habilitar si hay un error en la validaci√≥n local
            btnEnviarModal.textContent = 'Enviar Pedido';
            return;
        }

        let pedidosEnLocalStorage = JSON.parse(localStorage.getItem("pedidos")) || [];
        let fecha = obtenerFechaFormateada();
        let rowsParaPdf = []; // Para el PDF que se genera localmente
        let hayErroresDeEnvio = false; // Bandera para saber si hubo alg√∫n fallo en Google Sheets

        // Recorremos los productos usando un bucle for...of para poder usar await
        for (let i = 0; i < products.length; i++) {
            let productoVal = products[i].value;
            let cantidadVal = parseInt(quantities[i].value);
            let observacionVal = observations[i].value;

            const pedidoData = {
                fecha,
                nombre,
                producto: productoVal,
                cantidad: cantidadVal,
                observacion: observacionVal,
                impreso: "No"
            };

            // Guarda en localStorage *inmediatamente* (es local y r√°pido)
            // Esto asegura que el pedido se guarde localmente aunque falle el env√≠o a Google Sheets.
            pedidosEnLocalStorage.push(pedidoData);

            try {
                // Esperamos que cada env√≠o a Google Sheets se complete antes de continuar
                await enviarPedidoAGoogleSheets(
                    pedidoData.fecha,
                    pedidoData.nombre,
                    pedidoData.producto,
                    pedidoData.cantidad,
                    pedidoData.observacion,
                    pedidoData.impreso
                );
            } catch (error) {
                // Este catch solo se activar√° si todos los reintentos dentro de 
                // enviarPedidoAGoogleSheets fallan para un producto espec√≠fico.
                console.error(`ERROR FATAL: El pedido para "${pedidoData.producto}" no pudo ser enviado a Google Sheets despu√©s de m√∫ltiples reintentos.`);
                hayErroresDeEnvio = true;
            }

            rowsParaPdf.push([
                productoVal,
                cantidadVal,
                observacionVal || "Sin observaciones"
            ]);
        }

        localStorage.setItem("pedidos", JSON.stringify(pedidosEnLocalStorage));

        // Generar PDF autom√°ticamente despu√©s de intentar enviar todo
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(14);
        doc.text(`Pedido de: ${nombre}`, 10, 10);
        doc.text(`Fecha: ${fecha}`, 10, 20);

        doc.autoTable({
            startY: 30,
            head: [['Producto', 'Cantidad', 'Observaciones']],
            body: rowsParaPdf,
        });

        doc.save(`Pedido_${nombre}_${fecha.replace(/[/: ]/g, '_')}.pdf`);

        // Mensaje final al usuario en el modal y manejo del cierre
        if (hayErroresDeEnvio) {
            modalStatusMessage.textContent = "¬°Proceso de env√≠o completado con ALGUNOS ERRORES! Algunos √≠tems no pudieron ser registrados en Google Sheets. Por favor, revisa la consola del navegador y los logs de Google Apps Script.";
            modalStatusMessage.className = 'message-container error-message';
            // El bot√≥n se re-habilita autom√°ticamente en el `finally` si el error fue de la promesa de fetch.
            // Si el modal debe quedarse abierto en caso de error, no llamamos a `cerrarModal()`.
            btnEnviarModal.textContent = 'Reintentar Env√≠o'; // Permite reintentar si el usuario quiere
            btnEnviarModal.disabled = false; // Re-habilitar el bot√≥n para permitir reintentar
        } else {
            modalStatusMessage.textContent = "¬°Pedido enviado correctamente! Todos los √≠tems fueron registrados en Google Sheets.";
            modalStatusMessage.className = 'message-container success-message';
            // Si todo sali√≥ bien, cerramos el modal despu√©s de un breve retraso para que el usuario lea el mensaje
            setTimeout(() => {
                cerrarModal();
                // Limpiar el formulario principal despu√©s del env√≠o exitoso y cierre del modal
                pedidoForm.reset();
                productosContainer.innerHTML = ""; // Limpiar productos agregados
                actualizarEstado(); // Actualizar el estado de la impresi√≥n
            }, 1500); // Retraso de 1.5 segundos
        }
    }

    function cerrarModal() {
        modalConfirmacion.style.display = "none";
    }

    // --- FUNCION ANULAR PEDIDO con reintentos ---
    async function anularPedido() {
        // Deshabilitar el bot√≥n de Anular Pedido si es necesario (no hay modal aqu√≠ directamente)
        // Podr√≠as mostrar un mensaje de "Anulando..." en el formulario principal.
        
        let nombre = nombreClienteInput.value;
        let productos = document.querySelectorAll(".producto");
        let cantidades = document.querySelectorAll(".cantidad");
        let observaciones = document.querySelectorAll(".observacion");

        if (!nombre || productos.length === 0) {
            alert("Debes ingresar un nombre y al menos un producto para anular.");
            return;
        }

        let fecha = obtenerFechaFormateada();
        let pedidosEnLocalStorage = JSON.parse(localStorage.getItem("pedidos")) || [];
        let hayErroresDeAnulacion = false;

        for (let i = 0; i < products.length; i++) {
            let cantidadNegativa = -parseInt(quantities[i].value); 
            const pedidoAnuladoData = {
                fecha,
                nombre,
                producto: products[i].value,
                cantidad: cantidadNegativa,
                observacion: observations[i].value,
                impreso: "No"
            };

            pedidosEnLocalStorage.push(pedidoAnuladoData);

            try {
                await enviarPedidoAGoogleSheets(
                    pedidoAnuladoData.fecha,
                    pedidoAnuladoData.nombre,
                    pedidoAnuladoData.producto,
                    pedidoAnuladoData.cantidad,
                    pedidoAnuladoData.observacion,
                    pedidoAnuladoData.impreso
                );
            } catch (error) {
                console.error(`ERROR FATAL: La anulaci√≥n para "${pedidoAnuladoData.producto}" no pudo ser enviada despu√©s de m√∫ltiples reintentos.`);
                hayErroresDeAnulacion = true;
            }
        }
        
        localStorage.setItem("pedidos", JSON.stringify(pedidosEnLocalStorage));

        if (hayErroresDeAnulacion) {
            alert("¬°Proceso de anulaci√≥n completado con ALGUNOS ERRORES! No todas las anulaciones pudieron ser registradas en Google Sheets. Revisa la consola.");
        } else {
            alert("¬°Pedido anulado correctamente! Todas las anulaciones fueron registradas en Google Sheets.");
        }

        pedidoForm.reset();
        productosContainer.innerHTML = ""; // Limpiar productos agregados
        actualizarEstado(); 
        // No hay modal de anulaci√≥n, as√≠ que no se llama a cerrarModal aqu√≠ directamente.
    }

    // --- Funciones de administraci√≥n y reportes (sin cambios principales) ---
    function descargarPDFPedido() {
        let nombre = nombreClienteInput.value;
        let products = document.querySelectorAll(".producto");
        let quantities = document.querySelectorAll(".cantidad");
        let observations = document.querySelectorAll(".observacion");

        if (!nombre || products.length === 0) {
            alert("Debes completar un pedido antes de generar el PDF.");
            return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        let fecha = obtenerFechaFormateada();

        doc.setFontSize(14);
        doc.text(`Pedido de: ${nombre}`, 10, 10);
        doc.text(`Fecha: ${fecha}`, 10, 20);

        let rows = [];

        products.forEach((product, index) => {
            rows.push([
                product.value,
                quantities[index].value,
                observations[index].value || "Sin observaciones"
            ]);
        });

        doc.autoTable({
            startY: 30,
            head: [['Producto', 'Cantidad', 'Observaciones']],
            body: rows,
        });

        doc.save(`Pedido_${nombre}_${fecha.replace(/[/: ]/g, '_')}.pdf`);
    }
    
    function accederAdmin() {
        let clave = prompt("Ingrese la clave de administrador:");
        if (clave === "admin123") {
            document.getElementById("adminPanel").style.display = "block";
            mostrarPedidos();
            actualizarEstado();  
        } else {
            alert("Clave incorrecta.");
        }
    }
    
    function solicitarClaveParaImpresion() {
        const claveCorrecta = "admin123"; 
        const claveIngresada = prompt("Ingrese la clave para imprimir:");

        if (claveIngresada === claveCorrecta) {
            generarPDF(); 
        } else {
            alert("Clave incorrecta. No se puede imprimir.");
        }
    }

    function eliminarTodosLosPedidos() {
        if (confirm("¬øEst√°s seguro de que quieres eliminar todos los pedidos? Esta acci√≥n no se puede deshacer.")) {
            localStorage.removeItem("pedidos"); 
            mostrarPedidos(); 
            actualizarEstado(); 
            alert("Todos los pedidos han sido eliminados.");
        }
    }

    function mostrarPedidos() {
        let pedidos = JSON.parse(localStorage.getItem("pedidos")) || [];

        if (pedidos.length > 200) {
            pedidos = pedidos.slice(-200); 
            localStorage.setItem("pedidos", JSON.stringify(pedidos)); 
        }

        let tbody = document.querySelector("#tablaPedidos tbody");
        tbody.innerHTML = "";
        pedidos.forEach((p, index) => {
            let fila = `<tr>
                <td>${p.fecha}</td>
                <td>${p.nombre}</td>
                <td>${p.producto}</td>
                <td>${p.cantidad}</td>
                <td>${p.observacion}</td>
                <td>${p.impreso}</td>
                <td><button onclick="eliminarPedido(${index})">‚ùå</button></td>
            </tr>`;
            tbody.innerHTML += fila;
        });
    }
    
    function eliminarPedido(index) {
        let pedidos = JSON.parse(localStorage.getItem("pedidos")) || [];
        pedidos.splice(index, 1); 
        localStorage.setItem("pedidos", JSON.stringify(pedidos));
        mostrarPedidos(); 
        actualizarEstado(); 
    }

    window.onload = function() {
        actualizarEstado(); 
    };

    function generarPDF() {
        const { jsPDF } = window.jspdf;
        let doc = new jsPDF({ orientation: "landscape" });
        let pedidos = JSON.parse(localStorage.getItem("pedidos")) || [];
        
        let pedidosNoImpresos = pedidos.filter(p => p.impreso === "No");

        if (pedidosNoImpresos.length === 0) {
            alert("No hay pedidos nuevos para imprimir.");
            return;
        }

        let fechaActual = new Date().toLocaleDateString();

        doc.setFontSize(14);
        doc.text(`Pedidos - Cuadro de Doble Entrada`, 14, 15);
        doc.text(`Fecha: ${fechaActual}`, 240, 15); 

        let clientesUnicos = [...new Set(pedidosNoImpresos.map(p => p.nombre))];
        let productosUnicos = [...new Set(pedidosNoImpresos.map(p => p.producto))];

        let tableHead = [["Producto", ...clientesUnicos]];
        let tableBody = productosUnicos.map(prod => {
            let row = [prod];
            clientesUnicos.forEach(cliente => {
                let total = pedidosNoImpresos
                    .filter(p => p.nombre === cliente && p.producto === prod)
                    .reduce((sum, p) => sum + p.cantidad, 0);
                row.push(total > 0 ? total : "");
            });
            return row;
        });

        doc.autoTable({ head: tableHead, body: tableBody, startY: 25 });

        let startY = doc.autoTable.previous.finalY + 10;
        doc.text("Observaciones por Cliente y Producto", 14, startY);
        startY += 6;

        let observacionesAgrupadas = {};
        pedidosNoImpresos.forEach(p => {
            if (p.observacion && p.observacion.trim()) { // Asegurarse de que la observaci√≥n no est√© vac√≠a
                if (!observacionesAgrupadas[p.nombre]) {
                    observacionesAgrupadas[p.nombre] = [];
                }
                observacionesAgrupadas[p.nombre].push(`${p.producto}: ${p.observacion}`);
            }
        });

        if (Object.keys(observacionesAgrupadas).length > 0) {
            Object.entries(observacionesAgrupadas).forEach(([cliente, observaciones]) => {
                doc.setFontSize(12);
                // Si la l√≠nea es muy larga, autoTable puede no manejarla bien, pero para observaciones cortas funciona.
                doc.text(`${cliente}: ${observaciones.join("; ")}`, 14, startY, { maxWidth: 260, align: 'left' }); // A√±adir maxWidth para evitar desbordamiento
                startY += Math.ceil(doc.getStringUnitWidth(`${cliente}: ${observaciones.join("; ")}`) * 12 / 260) * 4; // Ajuste de Y para l√≠neas largas
            });
        } else {
            doc.text("No hay observaciones.", 14, startY);
        }

        pedidos.forEach(p => {
            // Marcar como "S√≠" solo los pedidos que estaban en pedidosNoImpresos y han sido incluidos en el PDF
            if (pedidosNoImpresos.some(noImp => 
                noImp.fecha === p.fecha && 
                noImp.nombre === p.nombre && 
                noImp.producto === p.producto && 
                noImp.cantidad === p.cantidad && 
                noImp.observacion === p.observacion)) {
                p.impreso = "S√≠";
            }
        });

        localStorage.setItem("pedidos", JSON.stringify(pedidos));

        actualizarEstado();

        doc.save(`Pedidos_${fechaActual}.pdf`);
    }

    function actualizarEstado() {
        const pedidos = JSON.parse(localStorage.getItem("pedidos")) || [];
        const hayPendientes = pedidos.some(p => p.impreso === "No");

        const estadoForm = document.getElementById("estadoImpresion");
        const estadoAdmin = document.getElementById("estadoImpresionAdmin"); 
        const cartel = document.getElementById("nuevoPedido");

        if (hayPendientes) {
            if (estadoForm) estadoForm.style.backgroundColor = "green";
            if (estadoAdmin) estadoAdmin.style.backgroundColor = "green";
            if (cartel) cartel.style.display = "block";
        } else {
            if (estadoForm) estadoForm.style.backgroundColor = "blue";
            if (estadoAdmin) estadoAdmin.style.backgroundColor = "blue";
            if (cartel) cartel.style.display = "none";
        }
    }
    
    function generarPDFCompleto() {
        const { jsPDF } = window.jspdf;
        let doc = new jsPDF({ orientation: "landscape" });
        let pedidos = JSON.parse(localStorage.getItem("pedidos")) || [];

        if (pedidos.length === 0) {
            alert("No hay pedidos para imprimir.");
            return;
        }

        let clientesUnicos = [...new Set(pedidos.map(p => p.nombre))];
        let productosUnicos = [...new Set(pedidos.map(p => p.producto))];

        let tableHead = [["Producto", ...clientesUnicos]];
        let tableBody = productosUnicos.map(prod => {
            let row = [prod];
            clientesUnicos.forEach(cliente => {
                let total = pedidos
                    .filter(p => p.nombre === cliente && p.producto === prod)
                    .reduce((sum, p) => sum + p.cantidad, 0);
                row.push(total > 0 ? total : "");
            });
            return row;
        });

        doc.setFontSize(14);
        doc.text("Pedidos - Cuadro de Doble Entrada (Completo)", 14, 15);
        doc.autoTable({ head: tableHead, body: tableBody, startY: 20 });

        let startY = doc.autoTable.previous.finalY + 10;
        doc.setFontSize(14);
        doc.text("Observaciones por Cliente y Producto", 14, startY);
        startY += 6;

        let observacionesAgrupadas = {};
        pedidos.forEach(p => {
            if (p.observacion && p.observacion.trim()) {
                if (!observacionesAgrupadas[p.nombre]) {
                    observacionesAgrupadas[p.nombre] = [];
                }
                observacionesAgrupadas[p.nombre].push(`${p.producto}: ${p.observacion}`);
            }
        });

        if (Object.keys(observacionesAgrupadas).length > 0) {
            Object.entries(observacionesAgrupadas).forEach(([cliente, observaciones]) => {
                doc.setFontSize(12);
                doc.text(`${cliente}: ${observaciones.join("; ")}`, 14, startY, { maxWidth: 260, align: 'left' });
                startY += Math.ceil(doc.getStringUnitWidth(`${cliente}: ${observaciones.join("; ")}`) * 12 / 260) * 4;
            });
        }
        
        doc.save("Pedidos_Completos.pdf");
    }

    function descargarExcel() {
        let pedidos = JSON.parse(localStorage.getItem("pedidos")) || [];
        let ws = XLSX.utils.json_to_sheet(pedidos);
        let wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Pedidos");
        XLSX.writeFile(wb, "Pedidos.xlsx");
    }

</script>
<div id="modalConfirmacion" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="cerrarModal()">&times;</span>
        <h3>Resumen del Pedido</h3>
        <div id="resumenPedido"></div>
        <p id="modalStatusMessage" style="margin-top: 15px; font-weight: bold;"></p>
        <button id="btnEnviarModal" onclick="enviarPedido()">Enviar Pedido</button>
        <button onclick="cerrarModal()">Cancelar</button>
    </div>
</div>

</body>
</html>
