<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Administración de Pedidos</title>
  <script src="https://www.gstatic.com/firebasejs/9.8.3/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.8.3/firebase-firestore.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.2/xlsx.full.min.js"></script>
  <style>
    /* Estilos básicos para la página */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    .btn {
      background-color: #4CAF50;
      color: white;
      padding: 10px 20px;
      margin: 10px 0;
      border: none;
      cursor: pointer;
    }
    .btn:hover {
      background-color: #45a049;
    }
    .estadoImpresion {
      padding: 10px;
      margin-top: 20px;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>Panel de Administración de Pedidos</h1>

  <!-- Formulario de ingreso de pedido -->
  <div>
    <h2>Agregar Pedido</h2>
    <label for="nombre">Nombre:</label><br>
    <input type="text" id="nombre" required><br><br>

    <label for="producto">Producto:</label><br>
    <input type="text" id="producto" required><br><br>

    <label for="cantidad">Cantidad:</label><br>
    <input type="number" id="cantidad" required><br><br>

    <label for="observacion">Observaciones:</label><br>
    <input type="text" id="observacion"><br><br>

    <button class="btn" onclick="enviarPedido()">Enviar Pedido</button>
  </div>

  <h2>Pedidos Registrados</h2>

  <!-- Tabla de pedidos -->
  <table id="tablaPedidos">
    <thead>
      <tr>
        <th>Fecha</th>
        <th>Cliente</th>
        <th>Producto</th>
        <th>Cantidad</th>
        <th>Observaciones</th>
        <th>Impreso</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      <!-- Los pedidos se mostrarán aquí dinámicamente -->
    </tbody>
  </table>

  <!-- Botones de acciones -->
  <div>
    <button class="btn" onclick="eliminarTodosLosPedidos()">Eliminar Todos</button>
    <button class="btn" onclick="generarPDF()">Generar PDF</button>
    <button class="btn" onclick="descargarExcel()">Descargar Excel</button>
  </div>

  <!-- Indicador de estado de impresión -->
  <div class="estadoImpresion" id="estadoImpresion">
    Estado de impresión: Esperando...
  </div>

  <script>
    // Configuración de Firebase
    const firebaseConfig = {
      apiKey: "TU_API_KEY",
      authDomain: "TU_AUTH_DOMAIN",
      projectId: "TU_PROJECT_ID",
      storageBucket: "TU_STORAGE_BUCKET",
      messagingSenderId: "TU_MESSAGING_SENDER_ID",
      appId: "TU_APP_ID",
      measurementId: "TU_MEASUREMENT_ID"
    };

    // Inicializar Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Función para enviar un pedido a Firestore
    function enviarPedido() {
      const nombre = document.getElementById("nombre").value;
      const producto = document.getElementById("producto").value;
      const cantidad = document.getElementById("cantidad").value;
      const observacion = document.getElementById("observacion").value;

      if (nombre && producto && cantidad) {
        db.collection("pedidos").add({
          nombre: nombre,
          producto: producto,
          cantidad: cantidad,
          observacion: observacion || "",
          fecha: new Date().toLocaleString(),
          impreso: "No"
        }).then(() => {
          alert("Pedido agregado correctamente.");
          mostrarPedidos(); // Refrescar la lista de pedidos
        }).catch((error) => {
          console.error("Error al agregar el pedido: ", error);
          alert("Hubo un problema al agregar el pedido.");
        });
      } else {
        alert("Por favor, complete todos los campos obligatorios.");
      }
    }

    // Función para mostrar los pedidos desde Firestore
    function mostrarPedidos() {
      const tablaPedidos = document.getElementById("tablaPedidos").getElementsByTagName('tbody')[0];
      tablaPedidos.innerHTML = ""; // Limpiar la tabla antes de cargar los nuevos datos

      db.collection("pedidos").get().then(querySnapshot => {
        querySnapshot.forEach(doc => {
          const pedido = doc.data();
          const row = tablaPedidos.insertRow();
          row.insertCell(0).textContent = pedido.fecha;
          row.insertCell(1).textContent = pedido.nombre;
          row.insertCell(2).textContent = pedido.producto;
          row.insertCell(3).textContent = pedido.cantidad;
          row.insertCell(4).textContent = pedido.observacion;
          row.insertCell(5).textContent = pedido.impreso;

          // Botón para eliminar el pedido
          const cell = row.insertCell(6);
          const button = document.createElement("button");
          button.textContent = "Eliminar";
          button.className = "btn";
          button.onclick = () => eliminarPedido(doc.id);
          cell.appendChild(button);
        });
      }).catch((error) => {
        console.error("Error al cargar los pedidos: ", error);
      });
    }

    // Función para eliminar un pedido desde Firestore
    function eliminarPedido(docId) {
      db.collection("pedidos").doc(docId).delete().then(() => {
        alert("Pedido eliminado correctamente.");
        mostrarPedidos(); // Refrescar la lista de pedidos
      }).catch((error) => {
        console.error("Error al eliminar el pedido: ", error);
        alert("Hubo un problema al eliminar el pedido.");
      });
    }

    // Función para eliminar todos los pedidos
    function eliminarTodosLosPedidos() {
      if (confirm("¿Estás seguro de que deseas eliminar todos los pedidos?")) {
        db.collection("pedidos").get().then(querySnapshot => {
          querySnapshot.forEach(doc => {
            db.collection("pedidos").doc(doc.id).delete();
          });
          alert("Todos los pedidos han sido eliminados.");
          mostrarPedidos(); // Refrescar la lista de pedidos
        }).catch((error) => {
          console.error("Error al eliminar todos los pedidos: ", error);
        });
      }
    }

    // Función para generar PDF con los pedidos
    function generarPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      let pedidos = [];
      db.collection("pedidos").get().then(querySnapshot => {
        querySnapshot.forEach(doc => {
          pedidos.push(doc.data());
        });

        const headers = [["Fecha", "Cliente", "Producto", "Cantidad", "Observaciones", "Impreso"]];
        const data = pedidos.map(p => [p.fecha, p.nombre, p.producto, p.cantidad, p.observacion, p.impreso]);

        doc.autoTable({
          head: headers,
          body: data,
        });

        doc.save("pedidos.pdf");
      });
    }

    // Función para descargar los pedidos en formato Excel
    function descargarExcel() {
      let pedidos = [];
      db.collection("pedidos").get().then(querySnapshot => {
        querySnapshot.forEach(doc => {
          pedidos.push(doc.data());
        });

        let ws = XLSX.utils.json_to_sheet(pedidos);
        let wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Pedidos");
        XLSX.writeFile(wb, "pedidos.xlsx");
      });
    }

    // Función para actualizar el estado de impresión
    function actualizarEstado() {
      db.collection("pedidos").where("impreso", "==", "No").get().then(querySnapshot => {
        let estadoColor = querySnapshot.empty ? "green" : "blue";
        document.getElementById("estadoImpresion").style.backgroundColor = estadoColor;
      });
    }

    // Inicializar estado de impresión
    actualizarEstado();

    // Cargar los pedidos cuando se abra la página
    mostrarPedidos();
  </script>
</body>
</html>
